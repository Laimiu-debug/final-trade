# 回测改造待办（全市场滚动 + 每日事件库持久化）

## 1. 背景与问题
- 当前全市场回测是先用 `date_to` 做一次截面选池，再回放 `date_from ~ date_to`。
- 该方式存在前视偏差（回看模式），不符合严格回测要求。
- 当前威科夫事件是在请求时动态计算，缺少可复用的“每日事件库”持久化，导致重算开销大、耗时不稳定。

## 2. 本轮目标
- 落地全市场三种滚动模式并可由用户切换：
- `daily`（按日滚动）
- `weekly`（按周滚动）
- `position`（持仓触发滚动）
- 落地“每日威科夫事件库”持久化，回测优先读库，缺失时再增量计算。
- 明确 `run_id` 在回测中的语义：用于参数模板，不再代表固定未来股票池。

## 3. 待办 A：全市场三种滚动模式落地

### A1. 统一模式定义
- [ ] `daily`：每个交易日重建当日可选股票池。
- [ ] `weekly`：每周首个交易日重建股票池，其余交易日沿用。
- [ ] `position`：首日建池；仅在发生卖出并需要补仓时，下一交易日重建股票池。

### A2. `run_id` 语义重定义
- [ ] 回测中 `run_id` 仅作为“筛选参数模板来源”。
- [ ] 若 `run_id` 不存在或为空：回退系统配置参数模板。
- [ ] 禁止“直接沿用 run 的固定股票列表”作为整个回测区间股票池。

### A3. 任务执行与超时策略
- [ ] 全市场三种模式全部走任务接口（避免同步请求超时）。
- [ ] 进度按“交易日进度”展示：当前日期、已处理/总交易日、百分比。
- [ ] 长区间时显示耗时提示与建议（分批回测、缩短区间等）。

### A4. 筛选与执行流程（全市场）
- [ ] 删除全市场待买信号的 `Top1500(score+ai_confidence*20)` 预截断，不再用趋势分做前置裁剪。
- [ ] 全市场待买信号按市场范围全量股票执行威科夫事件判定（策略口径等价于“全量跑威科夫”）。
- [ ] 每个刷新日根据当日截面计算候选池，再应用 `max_symbols`。
- [ ] 非刷新日沿用上次池（`weekly` / `position`）。
- [ ] 每日信号判定与交易执行仍使用当前威科夫规则（入场/出场/优先级/仓位约束）。
- [ ] 仅保留“系统保护上限”作为异常资源压力兜底，不参与策略筛选逻辑与排序逻辑。

### A5. 验收标准
- [ ] 同一参数下，`daily`、`weekly`、`position` 结果可复现且逻辑可解释。
- [ ] 全市场模式不再依赖 `date_to` 单点截面选池。
- [ ] 前端不会因长任务出现“同步超时即失败”。
- [ ] 在未触发系统保护上限时，结果与“无上限策略口径”一致。
- [ ] 触发系统保护上限时，前后端给出明确告警，不默默改变策略语义。

## 4. 待办 B：每日威科夫事件库持久化

### B1. 存储模型（建议）
- [ ] 新建事件表（建议 SQLite）：
- `symbol`
- `trade_date`
- `window_days`
- `event_dates`（JSON）
- `event_chain`（JSON）
- `phase/signal/quality_score/sequence_ok/event_count`
- `trend_score/phase_score/structure_score/volatility_score`
- `version/hash/updated_at`
- [ ] 复合索引：`(symbol, trade_date, window_days)`。

### B2. 计算与写入策略
- [ ] 增量构建：仅补齐缺失交易日。
- [ ] 新交易日运行时仅计算“当日增量”，不全量重算历史交易日。
- [ ] 历史记录默认不重算；仅在“算法版本变更 / 数据源修订 / 参数口径变更”时触发重建。
- [ ] 支持批量回填历史区间（按市场、按日期窗口）。
- [ ] 计算版本变更时支持失效重建（避免旧口径污染）。

### B3. 读取策略（回测/信号）
- [ ] 回测优先读取事件库。
- [ ] 缺失记录时即时计算并回写（lazy fill）。
- [ ] 提供“只读库/允许回写”开关（便于生产控制）。
- [ ] 事件记录需带版本键（至少包含 `window_days`、算法版本、数据源版本）用于判定是否可复用。

### B4. 性能与稳定性目标
- [ ] 事件库首次全量构建允许耗时较长；后续按日增量更新耗时应显著下降。
- [ ] 同等参数下二次回测耗时显著下降（目标：降低 50% 以上）。
- [ ] 任务失败可恢复（重启后继续增量，不整段重算）。
- [ ] 增加数据质量检查（空事件、异常分值、跨日错位）。

### B5. 验收标准
- [ ] 重启后事件数据仍可复用。
- [ ] 回测结果在“动态计算”和“读库计算”口径一致（允许浮点微差）。
- [ ] 事件库缺失场景能自动补齐且不影响任务完成。
- [ ] 连续两天运行时，第二天只新增新交易日记录；历史记录 `updated_at` 不应被批量刷新。

## 5. 里程碑建议
- [ ] M1（先可用）：全市场三种滚动 + 全任务化 + 进度条稳定。
- [ ] M2（提性能）：事件库落地 + 回测读库 + 增量回填。
- [ ] M3（提可运维）：版本化重建、诊断页、统计报表（命中率/覆盖率/缺失率）。

## 6. 待讨论清单（本轮继续讨论用）
- [ ] 全市场滚动筛选参数来源优先级：`run_id` > 当前页面参数 > 系统配置？
- [ ] `position` 模式的“触发重建”条件是否仅限“卖出导致空位”，还是包括止损/止盈/超时全部卖出原因？
- [ ] 事件库粒度是否固定 `window_days`，还是多窗口并存？
- [ ] 事件库是否需要区分数据源（TDX/AkShare）并纳入版本键？
- [ ] 是否需要“冻结参数快照”写入回测结果，保证审计可追溯？

## 7. 非目标（本轮不做）
- 不做策略因子新增与模型重训。
- 不改交易撮合规则（仅沿用现有回测执行规则）。
- 不做多账户/分布式任务调度。
